#cloud-config

final_message: "The system is finally up, after $UPTIME seconds"

# We add Conda using RPM/APT
yum_repos:
  conda:
    name: Conda
    baseurl: https://repo.anaconda.com/pkgs/misc/rpmrepo/conda
    enabled: true
    gpgcheck: true
    gpgkey: https://repo.anaconda.com/pkgs/misc/gpgkeys/anaconda.asc

packages:
  - conda
#package_upgrade: true

users:
  - default
  - name: ${user}
    lock_passwd: true
    ssh_redirect_user: true

write_files:
  - path: /etc/sysconfig/jupyterhub-singleuser
    encoding: b64
    content: ${environment_b64}

  - path: /etc/systemd/system/jupyterhub-user-${user}.service
    content: |
      # Auto-Generated by sodre/terraform-triton-jupyterhub-singleuser
      [Unit]
      Description=${user}'s JupyterHub server.
      After=network.target remote-fs.target nss-lookup.target

      [Service]
      Type=simple
      User=${user}
      WorkingDirectory=/home/${user}
      EnvironmentFile=/etc/sysconfig/jupyterhub-singleuser
      ExecStart=/opt/conda/bin/conda-exec -- base jupyter-labhub --ip ${ip} --port ${port} --notebook-dir ~
      KillSignal=SIGKILL

      [Install]
      WantedBy=multi-user.target

runcmd:
  - ln -s /opt/conda/etc/profile.d/conda.{csh,sh} /etc/profile.d/
  - |
    source /etc/profile.d/conda.sh
    conda install -n base -qy conda-forge::conda-exec anaconda-client nb_conda_kernels jupyterlab jupyterhub
    systemctl daemon-reload
    systemctl start jupyterhub-user-${user}
